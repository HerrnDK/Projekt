[
    {
        "id":  "flow_fn_parameters",
        "type":  "tab",
        "label":  "Funktion - Parameter",
        "disabled":  false,
        "info":  "Verwaltet Dashboard-Parameter und berechnet abgeleitete Sensorwerte"
    },
    {
        "id":  "inject_param_offset_init",
        "type":  "inject",
        "z":  "flow_fn_parameters",
        "name":  "Offset initialisieren (Boot)",
        "props":  [
                      {
                          "p":  "payload"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  true,
        "onceDelay":  "1",
        "topic":  "",
        "payload":  "INIT_OFFSET",
        "payloadType":  "str",
        "x":  220,
        "y":  80,
        "wires":  [
                      [
                          "fn_param_default_offset"
                      ]
                  ]
    },
    {
        "id":  "fn_param_default_offset",
        "type":  "function",
        "z":  "flow_fn_parameters",
        "name":  "Default-Offset setzen",
        "func":  "const clampInt = (value, min, max) => Math.max(min, Math.min(max, Math.round(value)));\n\nconst currentHcsr04 = Number(global.get(\"hcsr04_offset_cm\"));\nconst currentDroplet = Number(global.get(\"droplet_offset_raw\"));\n\nconst hcsr04Offset = clampInt(Number.isFinite(currentHcsr04) ? currentHcsr04 : 0, -5, 5);\nconst dropletOffset = clampInt(Number.isFinite(currentDroplet) ? currentDroplet : 0, -300, 300);\n\nglobal.set(\"hcsr04_offset_cm\", hcsr04Offset);\nglobal.set(\"droplet_offset_raw\", dropletOffset);\n\nmsg.payload = {\n  hcsr04_offset_cm: hcsr04Offset,\n  droplet_offset_raw: dropletOffset\n};\nreturn msg;",
        "outputs":  1,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  480,
        "y":  80,
        "wires":  [
                      [
                          "link_out_parameters_state"
                      ]
                  ]
    },
    {
        "id":  "link_in_from_dashboard_parameters",
        "type":  "link in",
        "z":  "flow_fn_parameters",
        "name":  "from dashboard (parameters)",
        "links":  [
                      "b8c0e9d3f4a15412"
                  ],
        "x":  220,
        "y":  160,
        "wires":  [
                      [
                          "fn_parameters_set_offset"
                      ]
                  ]
    },
    {
        "id":  "fn_parameters_set_offset",
        "type":  "function",
        "z":  "flow_fn_parameters",
        "name":  "Offset speichern",
        "func":  "const clampInt = (value, min, max) => Math.max(min, Math.min(max, Math.round(value)));\n\nconst key = String(msg.topic || \"hcsr04_offset_cm\");\nconst raw = Number(msg.payload);\nif (!Number.isFinite(raw)) {\n  return null;\n}\n\nif (key === \"hcsr04_offset_cm\") {\n  global.set(\"hcsr04_offset_cm\", clampInt(raw, -5, 5));\n} else if (key === \"droplet_offset_raw\") {\n  global.set(\"droplet_offset_raw\", clampInt(raw, -300, 300));\n} else {\n  return null;\n}\n\nconst currentHcsr04 = Number(global.get(\"hcsr04_offset_cm\"));\nconst currentDroplet = Number(global.get(\"droplet_offset_raw\"));\n\nconst hcsr04Offset = clampInt(Number.isFinite(currentHcsr04) ? currentHcsr04 : 0, -5, 5);\nconst dropletOffset = clampInt(Number.isFinite(currentDroplet) ? currentDroplet : 0, -300, 300);\n\nglobal.set(\"hcsr04_offset_cm\", hcsr04Offset);\nglobal.set(\"droplet_offset_raw\", dropletOffset);\n\nmsg.payload = {\n  hcsr04_offset_cm: hcsr04Offset,\n  droplet_offset_raw: dropletOffset\n};\nreturn msg;",
        "outputs":  1,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  470,
        "y":  160,
        "wires":  [
                      [
                          "link_out_parameters_state"
                      ]
                  ]
    },
    {
        "id":  "link_out_parameters_state",
        "type":  "link out",
        "z":  "flow_fn_parameters",
        "name":  "to dashboard (parameter state)",
        "mode":  "link",
        "links":  [
                      "8f6abcf84d0f4e29"
                  ],
        "x":  740,
        "y":  120,
        "wires":  [

                  ]
    },
    {
        "id":  "link_in_from_data_parameters",
        "type":  "link in",
        "z":  "flow_fn_parameters",
        "name":  "from data exchange (sensors)",
        "links":  [
                      "link_out_from_data"
                  ],
        "x":  220,
        "y":  260,
        "wires":  [
                      [
                          "fn_parameters_apply_offset"
                      ]
                  ]
    },
    {
        "id":  "fn_parameters_apply_offset",
        "type":  "function",
        "z":  "flow_fn_parameters",
        "name":  "Offset auf Distanz anwenden",
        "func":  "const p = msg.payload || {};\nif (String(p.type || \"\") !== \"sensor\") {\n  return null;\n}\n\nconst clampInt = (value, min, max) => Math.max(min, Math.min(max, Math.round(value)));\n\nlet hcsr04Offset = Number(global.get(\"hcsr04_offset_cm\"));\nif (!Number.isFinite(hcsr04Offset)) {\n  hcsr04Offset = 0;\n}\nhcsr04Offset = clampInt(hcsr04Offset, -5, 5);\np.hcsr04_offset_cm = hcsr04Offset;\n\nlet dropletOffset = Number(global.get(\"droplet_offset_raw\"));\nif (!Number.isFinite(dropletOffset)) {\n  dropletOffset = 0;\n}\ndropletOffset = clampInt(dropletOffset, -300, 300);\np.droplet_offset_raw = dropletOffset;\n\nconst hcsr04Raw = Number(p.hcsr04_distance_cm);\nconst hcsr04Status = String(p.hcsr04_status || \"missing\");\nif (hcsr04Status === \"ok\" && Number.isFinite(hcsr04Raw)) {\n  p.hcsr04_distance_display_cm = hcsr04Raw + hcsr04Offset;\n} else {\n  p.hcsr04_distance_display_cm = p.hcsr04_distance_cm;\n}\n\nconst dropletRaw = Number(p.droplet_raw);\nconst dropletStatus = String(p.droplet_status || \"missing\");\nif (dropletStatus === \"ok\" && Number.isFinite(dropletRaw)) {\n  p.droplet_display_raw = clampInt(dropletRaw + dropletOffset, 0, 1023);\n} else {\n  p.droplet_display_raw = p.droplet_raw;\n}\n\nmsg.payload = p;\nreturn msg;",
        "outputs":  1,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  500,
        "y":  260,
        "wires":  [
                      [
                          "link_out_parameters_to_dashboard"
                      ]
                  ]
    },
    {
        "id":  "link_out_parameters_to_dashboard",
        "type":  "link out",
        "z":  "flow_fn_parameters",
        "name":  "to dashboard (sensor values)",
        "mode":  "link",
        "links":  [
                      "2a616d8b76b4fe2c"
                  ],
        "x":  760,
        "y":  260,
        "wires":  [

                  ]
    }
]
