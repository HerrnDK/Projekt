[
    {
        "id":  "flow_fn_profiles",
        "type":  "tab",
        "label":  "Funktion - Profile",
        "disabled":  false,
        "info":  "RFID Lernen und Profilzuordnung"
    },
    {
        "id":  "inject_profiles_init",
        "type":  "inject",
        "z":  "flow_fn_profiles",
        "name":  "Profile initialisieren (Boot)",
        "props":  [
                      {
                          "p":  "payload"
                      }
                  ],
        "repeat":  "",
        "crontab":  "",
        "once":  true,
        "onceDelay":  "1",
        "topic":  "",
        "payload":  "INIT_PROFILES",
        "payloadType":  "str",
        "x":  220,
        "y":  80,
        "wires":  [
                      [
                          "fn_profiles_controller"
                      ]
                  ]
    },
    {
        "id":  "inject_profiles_poll",
        "type":  "inject",
        "z":  "flow_fn_profiles",
        "name":  "RFID Poll (2s)",
        "props":  [
                      {
                          "p":  "payload"
                      }
                  ],
        "repeat":  "2",
        "crontab":  "",
        "once":  true,
        "onceDelay":  "2",
        "topic":  "",
        "payload":  "RFID_POLL",
        "payloadType":  "str",
        "x":  210,
        "y":  140,
        "wires":  [
                      [
                          "fn_profiles_controller"
                      ]
                  ]
    },
    {
        "id":  "link_in_from_dashboard_profiles",
        "type":  "link in",
        "z":  "flow_fn_profiles",
        "name":  "from dashboard (profiles)",
        "links":  [
                      "link_out_dashboard_to_profiles"
                  ],
        "x":  230,
        "y":  220,
        "wires":  [
                      [
                          "fn_profiles_controller"
                      ]
                  ]
    },
    {
        "id":  "link_in_from_data_profiles",
        "type":  "link in",
        "z":  "flow_fn_profiles",
        "name":  "from data exchange (rfid)",
        "links":  [
                      "link_out_from_data"
                  ],
        "x":  220,
        "y":  300,
        "wires":  [
                      [
                          "fn_profiles_controller"
                      ]
                  ]
    },
    {
        "id":  "fn_profiles_controller",
        "type":  "function",
        "z":  "flow_fn_profiles",
        "name":  "RFID Profile Controller",
        "func":  "const state = flow.get(\"rfid_profile_state\") || {\n  chip_uids: { \"1\": \"\", \"2\": \"\" },\n  chip_profiles: { \"1\": 1, \"2\": 2 },\n  last_uid: \"\",\n  active_profile: 0,\n  hw_status: \"unknown\",\n  train_mode: false,\n  status_text: \"Profile initialisiert.\"\n};\n\nconst mapHwStatusText = (hw) =\u003e {\n  if (hw === \"ok\") return \"ok\";\n  if (!hw) return \"stoerung (unknown)\";\n  return \"stoerung (\" + hw + \")\";\n};\n\nconst buildLearningText = () =\u003e {\n  const slot1Free = !state.chip_uids[\"1\"];\n  const slot2Free = !state.chip_uids[\"2\"];\n  if (!state.train_mode) return \"Bereit\";\n  if (slot1Free) return \"Anlernen aktiv: warte auf Chip fuer Profil 1\";\n  if (slot2Free) return \"Anlernen aktiv: warte auf Chip fuer Profil 2\";\n  return \"Anlernen aktiv: beide Profile bereits belegt\";\n};\n\nconst buildUiMessage = () =\u003e ({\n  payload: {\n    profile_status_text: state.status_text,\n    rfid_hw_status_text: mapHwStatusText(state.hw_status),\n    rfid_learning_text: buildLearningText(),\n    rfid_chip1_uid: state.chip_uids[\"1\"] || \"-\",\n    rfid_chip1_profile: \"Profil 1\",\n    rfid_chip2_uid: state.chip_uids[\"2\"] || \"-\",\n    rfid_chip2_profile: \"Profil 2\",\n    rfid_last_uid: state.last_uid || \"-\",\n    rfid_active_profile: state.active_profile ? (\"Profil \" + state.active_profile) : \"-\"\n  }\n});\n\nconst saveState = () =\u003e {\n  flow.set(\"rfid_profile_state\", state);\n};\n\nconst requestRfidRead = () =\u003e [{ payload: \"RFID\" }, buildUiMessage()];\n\nconst payloadStr = (msg.payload === undefined || msg.payload === null) ? \"\" : String(msg.payload);\n\nif (payloadStr === \"INIT_PROFILES\") {\n  state.train_mode = false;\n  state.active_profile = 0;\n  if (typeof state.hw_status !== \"string\" || state.hw_status.length === 0) {\n    state.hw_status = \"unknown\";\n  }\n  state.status_text = \"Profile bereit.\";\n  saveState();\n  return [null, buildUiMessage()];\n}\n\nif (payloadStr === \"RFID_TRAIN\") {\n  state.train_mode = true;\n  state.status_text = \"RFID Anlernen gestartet. Chip auflegen.\";\n  saveState();\n  return requestRfidRead();\n}\n\nif (payloadStr === \"RFID_POLL\") {\n  saveState();\n  return requestRfidRead();\n}\n\nconst p = msg.payload || {};\nif (String(p.type || \"\") !== \"rfid\") {\n  return null;\n}\n\nconst hwStatus = String(p.rfid_hw_status || \"missing\");\nstate.hw_status = hwStatus;\n\nif (hwStatus !== \"ok\") {\n  state.active_profile = 0;\n  state.status_text = \"RFID Modulstatus: \" + hwStatus;\n  saveState();\n  return [null, buildUiMessage()];\n}\n\nconst status = String(p.rfid_status || \"missing\");\nconst uid = String(p.rfid_uid || \"\").trim();\n\nif (status === \"ok\" \u0026\u0026 uid) {\n  state.last_uid = uid;\n\n  if (state.train_mode) {\n    if (!state.chip_uids[\"1\"]) {\n      state.chip_uids[\"1\"] = uid;\n      state.status_text = \"Chip fuer Profil 1 angelernt: \" + uid;\n    } else if (!state.chip_uids[\"2\"]) {\n      state.chip_uids[\"2\"] = uid;\n      state.status_text = \"Chip fuer Profil 2 angelernt: \" + uid;\n    } else if (uid === state.chip_uids[\"1\"] || uid === state.chip_uids[\"2\"]) {\n      state.status_text = \"Bekannter Chip erneut gelesen.\";\n    } else {\n      state.status_text = \"Beide Profil-Slots belegt. Neuer Chip nicht gespeichert.\";\n    }\n    state.train_mode = false;\n  }\n\n  if (uid === state.chip_uids[\"1\"] \u0026\u0026 state.chip_uids[\"1\"]) {\n    state.active_profile = 1;\n    state.status_text = \"RFID erkannt: Profil 1 aktiv.\";\n  } else if (uid === state.chip_uids[\"2\"] \u0026\u0026 state.chip_uids[\"2\"]) {\n    state.active_profile = 2;\n    state.status_text = \"RFID erkannt: Profil 2 aktiv.\";\n  } else if (!state.train_mode) {\n    state.active_profile = 0;\n    state.status_text = \"Unbekannter RFID Chip: \" + uid;\n  }\n} else if (status === \"no_card\") {\n  state.active_profile = 0;\n  if (state.train_mode) {\n    state.status_text = \"Warte auf RFID Chip...\";\n  } else {\n    state.status_text = \"Kein RFID Chip erkannt.\";\n  }\n} else {\n  state.active_profile = 0;\n  state.status_text = \"RFID Fehler: \" + status;\n}\n\nsaveState();\nreturn [null, buildUiMessage()];",
        "outputs":  2,
        "noerr":  0,
        "initialize":  "",
        "finalize":  "",
        "libs":  [

                 ],
        "x":  520,
        "y":  220,
        "wires":  [
                      [
                          "link_out_profiles_to_data"
                      ],
                      [
                          "link_out_profiles_to_dashboard"
                      ]
                  ]
    },
    {
        "id":  "link_out_profiles_to_data",
        "type":  "link out",
        "z":  "flow_fn_profiles",
        "name":  "to data exchange (rfid cmd)",
        "mode":  "link",
        "links":  [
                      "link_in_from_dashboard"
                  ],
        "x":  840,
        "y":  200,
        "wires":  [

                  ]
    },
    {
        "id":  "link_out_profiles_to_dashboard",
        "type":  "link out",
        "z":  "flow_fn_profiles",
        "name":  "to dashboard (profiles state)",
        "mode":  "link",
        "links":  [
                      "link_in_profiles_from_fn"
                  ],
        "x":  850,
        "y":  240,
        "wires":  [

                  ]
    },
    {
        "id":  "debug_profiles",
        "type":  "debug",
        "z":  "flow_fn_profiles",
        "name":  "Profiles state",
        "active":  true,
        "tosidebar":  true,
        "console":  false,
        "complete":  "payload",
        "targetType":  "msg",
        "x":  830,
        "y":  300,
        "wires":  [

                  ]
    }
]
